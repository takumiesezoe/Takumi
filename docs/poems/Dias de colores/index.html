<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>D√≠as de colores ‚Äî Takumi</title>
<style>
  :root { --bg:#0d0d0d; --fg:#e5e5e5; --muted:#b3b3b3; --accent:#b19cd9; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:"Inter",system-ui,sans-serif;line-height:1.6;padding:2rem}
  h1{margin:0 0 .25rem;font-size:2rem;font-weight:800}
  p.sub{margin:.25rem 0 1.25rem;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .card{background:rgba(255,255,255,.05);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;transition:transform .15s ease, background .15s ease;text-decoration:none;color:inherit;cursor:pointer}
  .card:hover{transform:translateY(-2px);background:rgba(255,255,255,.08)}
  .thumb{width:100%;aspect-ratio:16/10;object-fit:cover;background:#1f1f1f}
  .meta{display:flex;align-items:center;gap:.6rem;padding:.9rem 1rem}
  .swatch{width:14px;height:14px;border-radius:50%;outline:1px solid rgba(255,255,255,.2);flex:0 0 14px}
  .title{font-weight:700;font-size:1rem}
  .error{color:#ff8585;margin:.5rem 0}
  .count{opacity:.75;margin:.25rem 0 1rem}

  /* Modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:flex-start;justify-content:center;padding:3vh 2rem;z-index:50}
  .overlay.show{display:flex}
  .sheet{width:100%;max-width:820px;border-radius:18px;overflow:hidden;background:rgba(20,20,20,.9);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.08);box-shadow:0 20px 80px rgba(0,0,0,.5)}
  .hero{min-height:130px;background:#222}
  .cover{width:100%;max-height:420px;object-fit:cover;display:block}
  .inner{padding:1.25rem 1.4rem}
  .sheet h2{margin:.1rem 0 1rem;font-size:1.6rem}
  .md{white-space:pre-wrap;line-height:1.7}
  .close{position:absolute;top:12px;right:16px;background:transparent;border:none;color:#fff;font-size:28px;cursor:pointer}
  .back{color:#b19cd9;text-decoration:none;margin-right:.5rem}
</style>

<!-- Parser Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <h1>üé® D√≠as de colores</h1>
  <p class="sub">Poemas y paletas por color ‚Äî parte del universo de <strong>Takumi</strong>.</p>
  <div id="error" class="error"></div>
  <div id="count" class="count">Cargando‚Ä¶</div>
  <div id="grid" class="grid"></div>

  <!-- Modal -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="sheet">
      <button class="close" id="closeBtn" aria-label="Cerrar">√ó</button>
      <div id="hero" class="hero"></div>
      <img id="cover" class="cover" alt="" style="display:none">
      <div class="inner">
        <a class="back" href="/Takumi/poems/Dias%20de%20colores/">‚Üê Volver a D√≠as de colores</a>
        <a class="back" id="openRaw" target="_blank" rel="noopener">Abrir .md</a>
        <h2 id="title">T√≠tulo</h2>
        <div id="content" class="md">‚Ä¶</div>
      </div>
    </div>
  </div>

<script>
(async()=>{
  const BASE = '/Takumi/poems/Dias%20de%20colores';
  const grid = document.getElementById('grid');
  const err  = document.getElementById('error');
  const count= document.getElementById('count');

  // Helpers globales
  const encPath = (p)=> p.split('/').map(encodeURIComponent).join('/');
  const toAbs   = (p)=> p.startsWith('http') ? p : (p.startsWith('/Takumi') ? p : `${BASE}/${encPath(p)}`);

  function card({title, slug, color, cover}) {
    const a = document.createElement('a');
    a.className = 'card';
    a.href = `#${encodeURIComponent(slug)}`;
    a.dataset.slug = slug;

    if (cover) {
      const img = document.createElement('img');
      img.className = 'thumb';
      img.loading = 'lazy';
      img.alt = title;
      img.src = toAbs(cover);
      a.appendChild(img);
    } else {
      const ph = document.createElement('div');
      ph.className = 'thumb';
      if (color) ph.style.background = color;
      a.appendChild(ph);
    }

    const meta = document.createElement('div');
    meta.className = 'meta';
    const sw = document.createElement('span');
    sw.className = 'swatch';
    if (color) sw.style.background = color;
    const t = document.createElement('div');
    t.className = 'title';
    t.textContent = title;
    meta.appendChild(sw);
    meta.appendChild(t);
    a.appendChild(meta);
    a.addEventListener('click',(e)=>{e.preventDefault(); openPoem(slug);});
    return a;
  }

  async function fetchPoem(slug){
    const url = `${BASE}/${encodeURIComponent(slug)}.md?ts=${Date.now()}`;
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) throw new Error('404');
    const raw = await r.text();

    let title = slug, color = null, cover = null, body = raw;
    const m = raw.match(/^---\s*([\s\S]*?)\s*---\s*/);
    if (m) {
      const fm = m[1];
      body = raw.slice(m[0].length);
      fm.split(/\r?\n/).forEach(line=>{
        const mm = line.match(/^([A-Za-z0-9_-]+)\s*:\s*(.*)$/);
        if(!mm) return;
        let [_, k, v] = mm;
        v = v.trim().replace(/^["']|["']$/g,'');
        if (k==='title' && v) title = v;
        else if (k==='color' && v) color = v;
        else if (k==='cover' && v) cover = v;
      });
    }
    return {title, color, cover, body, url};
  }

  // Conversi√≥n de Markdown (con soporte Obsidian)
function preprocessObsidian(md) {
  let txt = md;

  // ![[archivo.jpg]]  o  ![[carpeta/archivo.jpg|alt]]
  txt = txt.replace(/!\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g, (_, file, alt) => {
    const f = file.trim();
    // si no hay subcarpeta, apuntamos a images/
    const rel = f.includes('/') ? f : `images/${f}`;
    return `![${alt || f}](${rel})`;
  });

  // [[nota|alias]] -> alias
  txt = txt.replace(/\[\[([^\]|]+)\|([^\]]+)\]\]/g, (_, file, alias) => alias);
  txt = txt.replace(/\[\[([^\]]+)\]\]/g, (_, file) => file);

  // callouts
  txt = txt.replace(/^>\s*\[\!([^\]]+)\]\s*(.*)$/gmi, (m, kind, title) => {
    const label = title || kind;
    return `> **${label}**`;
  });

  return txt;
}

  function fixRelativeImageSrcs(html) {
    const container = document.createElement('div');
    container.innerHTML = html;
    container.querySelectorAll('img').forEach(img => {
      const src = img.getAttribute('src') || '';
      if (!/^https?:\/\//i.test(src) && !src.startsWith('/Takumi')) {
        img.src = toAbs(src);
      }
      img.style.maxWidth = '100%';
      img.style.borderRadius = '12px';
      img.style.margin = '.5rem 0';
    });
    return container.innerHTML;
  }

  function renderMarkdown(md) {
    marked.setOptions({ breaks: true });
    const pre = preprocessObsidian(md);
    const html = marked.parse(pre);
    return fixRelativeImageSrcs(html);
  }

  // Modal
  const overlay = document.getElementById('overlay');
  const hero    = document.getElementById('hero');
  const coverEl = document.getElementById('cover');
  const titleEl = document.getElementById('title');
  const contEl  = document.getElementById('content');
  const openRaw = document.getElementById('openRaw');
  const closeBtn= document.getElementById('closeBtn');

  function showModal(){ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); }
  function hideModal(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); history.replaceState(null,'',location.pathname); }

  async function openPoem(slug){
    try{
      const {title,color,cover,body,url} = await fetchPoem(slug);
      titleEl.textContent = title || slug;
      contEl.innerHTML = renderMarkdown(body.trim());
      hero.style.background = color || '#222';
      if (cover){
        coverEl.src = toAbs(cover);
        coverEl.style.display = '';
      } else {
        coverEl.style.display = 'none';
      }
      openRaw.href = url.replace('/Takumi','');
      showModal();
      history.replaceState(null,'',`#${encodeURIComponent(slug)}`);
    }catch(e){
      console.error(e);
      alert('No se pudo abrir el poema.');
    }
  }

  closeBtn.addEventListener('click', hideModal);
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) hideModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideModal(); });

  // Cargar tarjetas desde index.json
  try{
    const r = await fetch(`${BASE}/index.json?ts=${Date.now()}`, {cache:'no-store'});
    let data = [];
    if (r.ok) data = await r.json();
    const items = (Array.isArray(data)?data:[]).map(x=>{
      const slug  = (x.slug || x.title || '').replace(/\.md$/i,'');
      return { title: x.title || slug, slug, color: x.color || null, cover: x.cover || null };
    });
    grid.innerHTML = '';
    items.forEach(it=> grid.appendChild(card(it)));
    count.textContent = `üìú ${items.length} poema${items.length!==1?'s':''}`;
  }catch(e){
    console.error(e); err.textContent = 'Error al cargar el √≠ndice.'; count.textContent='';
  }

  // Abrir directamente si hay hash
  if (location.hash.length > 1){
    const slug = decodeURIComponent(location.hash.slice(1));
    openPoem(slug);
  }
})();
</script>
</body>
</html>
