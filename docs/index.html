<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Takumi ‚Äî √çndice</title>
  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      background-color: #0d0d0d;
      color: #e5e5e5;
      margin: 0;
      padding: 2rem;
      line-height: 1.6;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    section {
      margin-bottom: 2rem;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 0.4rem 0;
    }
    a {
      color: #b19cd9;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .error {
      color: #ff8080;
      margin-top: 0.5rem;
    }
    .collection-card {
      display: block;
      padding: 1rem;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      text-decoration: none;
      margin-bottom: 1rem;
      transition: background 0.2s;
    }
    .collection-card:hover {
      background: rgba(255,255,255,0.1);
    }
    .collection-title {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.3rem;
    }
    .collection-desc {
      opacity: 0.8;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>üåô Takumi</h1>

  <section id="poems">
    <h2>Poemas</h2>
    <div id="poem-error" class="error"></div>
    <ul id="poem-list"><li>Cargando poemas...</li></ul>
  </section>

  <section id="collections-section">
    <h2>Colecciones</h2>
    <div id="collections"><div>Cargando colecciones...</div></div>
  </section>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const BASE = '/Takumi';   // ra√≠z en GitHub Pages
  console.log('Takumi index boot (orden = index.md)', { BASE });

  const ul  = document.getElementById('poem-list');
  const err = document.getElementById('poem-error');
  const colWrap = document.getElementById('collections');

  async function safeText(url){
    const r = await fetch(url + `?ts=${Date.now()}`, { cache: 'no-store' });
    if(!r.ok) throw new Error(`${r.status} ${r.statusText} (${url})`);
    return r.text();
  }
  async function safeJSON(url){
    const r = await fetch(url + `?ts=${Date.now()}`, { cache: 'no-store' });
    if(!r.ok) throw new Error(`${r.status} ${r.statusText} (${url})`);
    return r.json();
  }

  // 1) Lee el orden desde poems/index.md
  async function getOrderFromMarkdown(){
    try{
      const md = await safeText(`${BASE}/poems/index.md`);
      // Extrae slugs en el orden de los enlaces del markdown
      // Soporta formatos: [T√≠tulo](/Takumi/poems/Slug.md) o (poems/Slug.md) o (Slug.md)
      const re = /\]\((?:\/?Takumi\/)?(?:docs\/)?poems\/([^)\s]+?)(?:\.md)?\)|\]\(([^)\s]+?)(?:\.md)?\)/gi;
      const order = [];
      let m;
      while((m = re.exec(md))){
        const raw = (m[1] || m[2] || '').replace(/^.*\//,'').replace(/\.md$/i,'').trim();
        if(raw && !order.includes(raw)) order.push(raw);
      }
      return order;
    }catch(e){
      console.warn('No se pudo leer poems/index.md, se usar√° JSON:', e);
      return [];
    }
  }

  // 2) Lee el inventario desde poems/index.json (para t√≠tulos/fechas)
  function normalizePoems(data){
    return (Array.isArray(data) ? data : []).map(it=>{
      if(typeof it === 'string'){
        const slug = it.replace(/^.*\//,'').replace(/\.md$/i,'');
        return { title: slug, slug };
      } else if (it && typeof it === 'object'){
        const slug = (it.slug || it.name || it.path || '').replace(/^.*\//,'').replace(/\.md$/i,'');
        return { title: it.title || slug, slug, date: it.date || null };
      }
      return null;
    }).filter(Boolean);
  }

  try{
    const [order, json] = await Promise.all([
      getOrderFromMarkdown(),
      safeJSON(`${BASE}/poems/index.json`)
    ]);

    const poems = normalizePoems(json);
    const bySlug = new Map(poems.map(p => [p.slug, p]));

    // Reordena seg√∫n index.md
    const ordered = [];
    order.forEach(slug=>{
      const p = bySlug.get(slug);
      if(p){ ordered.push(p); bySlug.delete(slug); }
    });
    // a√±ade al final los que no estaban en index.md
    for(const p of bySlug.values()) ordered.push(p);

    // Pinta
    ul.innerHTML = '';
    ordered.forEach(p=>{
      const li = document.createElement('li');
      const a  = document.createElement('a');
      a.textContent = p.title;
      a.href = `${BASE}/poems/${encodeURIComponent(p.slug)}.md`;
      li.appendChild(a);
      ul.appendChild(li);
    });
  }catch(e){
    if (err) err.textContent = `No se pudieron listar los poemas: ${e.message}`;
    console.error(e);
  }

  // ---- COLECCIONES (igual que antes) ----
  try{
    const cols = await safeJSON(`${BASE}/collections/index.json`);
    colWrap.innerHTML = '';
    (cols||[]).forEach(c=>{
      const card=document.createElement('a');
      card.className='collection-card';
      card.href = c.href || '#';

      const h=document.createElement('div'); h.className='collection-title'; h.textContent=c.title||'Colecci√≥n';
      const d=document.createElement('div'); d.className='collection-desc';  d.textContent=c.desc||'';

      card.appendChild(h); card.appendChild(d);
      colWrap.appendChild(card);
    });
  }catch(e){
    if (colWrap) colWrap.textContent = `No se pudieron cargar las colecciones: ${e.message}`;
    console.error(e);
  }
});
</script>
</body>
</html>
