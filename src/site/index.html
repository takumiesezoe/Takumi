<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>√çndice de Poemas ‚Äî Takumi‚Äôs Garden</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b0b0e;--card:#14141a;--muted:#b8b8c6;--text:#f3f3f7;--accent:#a78bfa}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:920px;margin:48px auto;padding:24px}
  .card{background:var(--card);border:1px solid #1f1f28;border-radius:16px;padding:24px}
  h1{margin:0 0 8px;font-size:clamp(22px,4vw,34px)}p.muted{color:var(--muted);margin:0 0 16px}
  .controls{display:flex;gap:12px;align-items:center;margin:8px 0 16px}
  input[type="search"]{flex:1;background:#0e0e13;border:1px solid #2a2a37;color:var(--text);padding:12px 14px;border-radius:12px;font-size:16px}
  .badge{font-size:12px;color:#c7c7d4;background:#1a1a24;border:1px solid #2a2a37;padding:3px 8px;border-radius:999px}
  ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
  .item a{display:inline-block;padding:12px 14px;border:1px solid #232330;border-radius:12px;background:#0f0f15;text-decoration:none;color:var(--text)}
  .item a:hover{border-color:var(--accent)}.date{margin-left:10px;color:#c9c9d3;font-size:12px}
  .viewer{margin-top:18px;padding:18px;border:1px solid #232330;border-radius:14px;background:#0f0f15}
  .back{display:inline-block;margin-bottom:10px;text-decoration:none;color:var(--accent)}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>üóÇÔ∏è √çndice de poemas</h1>
  <p id="status" class="muted">Cargando‚Ä¶</p>
  <div class="controls">
    <input id="q" type="search" placeholder="Buscar t√≠tulo‚Ä¶" />
    <span id="count" class="badge">0</span>
  </div>
  <ul id="lista" class="list"></ul>
  <div id="viewer" class="viewer" hidden>
    <a href="#" id="back" class="back">‚Üê Volver al √≠ndice</a>
    <div id="note"></div>
  </div>
</div></div>

<script>
  // RUTA al √≠ndice .md (relativa a src/site/) y carpeta base de poemas:
  const mdPath = "notes/Escritos/Canciones-poemas-escritos/Escritos_indice_con_enlace.md";
  const baseFolder = "Escritos/Canciones-poemas-escritos"; // cambia si tus poemas viven en otra carpeta

  const $status=document.getElementById("status"),$list=document.getElementById("lista"),
        $count=document.getElementById("count"),$q=document.getElementById("q"),
        $viewer=document.getElementById("viewer"),$note=document.getElementById("note"),
        $back=document.getElementById("back");

  // ===== Fechas: espa√±ol/ingl√©s, con "p. m." =====
  const meses = {
    'enero':1,'ene':1,'febrero':2,'feb':2,'marzo':3,'mar':3,'abril':4,'abr':4,'mayo':5,'may':5,
    'junio':6,'jun':6,'julio':7,'jul':7,'agosto':8,'ago':8,'septiembre':9,'setiembre':9,'sept':9,'set':9,
    'octubre':10,'oct':10,'noviembre':11,'nov':11,'diciembre':12,'dic':12,
    'january':1,'february':2,'march':3,'april':4,'june':6,'july':7,'august':8,'september':9,'october':10,'november':11,'december':12
  };

  function parseDate(raw){
    if(!raw) return null;
    let s = String(raw).trim();
    // quitar hora inicial tipo "6:44 p. m. - "
    s = s.replace(/^\s*\d{1,2}:\d{2}\s*(?:a\.?\s?m\.?|p\.?\s?m\.?|AM|PM)\s*[-‚Äì‚Äî]\s*/i,"");
    s = s.replace(/^\s*[-‚Äì‚Äî]\s*/,"");
    s = s.replace(/\s+/g," ").trim();
    let m;

    if(m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/)) return new Date(+m[1],+m[2]-1,+m[3]);
    if(m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/)) return new Date(+m[3],+m[2]-1,+m[1]);
    if(m=s.match(/^(\d{1,2})\s+de\s+([A-Za-z√°√©√≠√≥√∫√±\.]+)\s+de\s+(\d{4})$/i)){
      const D=+m[1], mes=m[2].toLowerCase().replace(/\./g,''), Y=+m[3]; const M=meses[mes]; if(M) return new Date(Y,M-1,D);
    }
    if(m=s.match(/^(\d{1,2})\s+([A-Za-z√°√©√≠√≥√∫√±\.]+)\s+(\d{4})$/i)){
      const D=+m[1], mes=m[2].toLowerCase().replace(/\./g,''), Y=+m[3]; const M=meses[mes]; if(M) return new Date(Y,M-1,D);
    }
    if(m=s.match(/^([A-Za-z√°√©√≠√≥√∫√±\.]+)\s+(\d{1,2}),\s*(\d{4})$/i)){
      const mes=m[1].toLowerCase().replace(/\./g,''), D=+m[2], Y=+m[3]; const M=meses[mes]; if(M) return new Date(Y,M-1,D);
    }
    if(m=s.match(/(\d{1,2})\s+(?:de\s+)?([A-Za-z√°√©√≠√≥√∫√±\.]+)\s+(?:de\s+)?(\d{4})/i)){
      const D=+m[1], mes=m[2].toLowerCase().replace(/\./g,''), Y=+m[3]; const M=meses[mes]; if(M) return new Date(Y,M-1,D);
    }
    const dt=new Date(s); return isNaN(dt)?null:dt;
  }

  function formatDate(d){ if(!d) return ""; const short=['ene','feb','mar','abr','may','jun','jul','ago','sept','oct','nov','dic']; return `${d.getDate()} ${short[d.getMonth()]} ${d.getFullYear()}`; }
  function titleFromTarget(t){return decodeURIComponent(t.split("/").pop().replace(/\.md$/i,""));}
  function targetToPath(t){ const clean=t.replace(/^notes\//,'').replace(/^\//,''); const withFolder=clean.includes('/')?clean:`${baseFolder}/${clean}`; return `notes/${withFolder.replace(/\.md$/i,'')}.md`; }

  fetch(encodeURI(mdPath))
  .then(async res=>{
    if(!res.ok) throw new Error("HTTP "+res.status);
    let md=await res.text();
    md=md.replace(/^---[\s\S]*?---\s*/,"").replace(/^\{[\s\S]*?\}\s*/,"");
    const lines=md.split(/\r?\n/);

    let headerIdx=-1,dateCol=-1,linkCol=-1;
    for(let i=0;i<lines.length;i++){ if(lines[i].includes('|') && /---/.test(lines[i+1]||'')){ headerIdx=i; break; } }
    if(headerIdx>=0){
      const headers=lines[headerIdx].split('|').map(c=>c.trim().toLowerCase());
      headers.forEach((h,idx)=>{ if(/fecha/.test(h)) dateCol=idx; if(/t[i√≠]tulo/.test(h)) linkCol=idx; });
    }

    const rows=[];
    for(let i=(headerIdx>=0?headerIdx+2:0);i<lines.length;i++){
      if(!lines[i].includes('|')) continue;
      const cells=lines[i].split('|').map(c=>c.trim());
      let linkCell=cells.find(c=>/\[\[.+\]\]/.test(c)); if(!linkCell) continue;
      const m=linkCell.match(/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/); if(!m) continue;
      const target=m[1].trim(), title=(m[2]||titleFromTarget(target)).trim();
      const dateText=(dateCol>=0&&cells[dateCol])?cells[dateCol]:"";
      const date=parseDate(dateText);
      rows.push({title,target,date});
    }

    rows.sort((a,b)=>{ if(a.date&&b.date) return b.date-a.date; if(a.date&&!b.date) return -1; if(!a.date&&b.date) return 1; return a.title.localeCompare(b.title,"es",{sensitivity:"base"}); });

    renderList(rows); $status.textContent="‚úÖ Cargado";
    $q.addEventListener("input",()=>{const q=$q.value.toLowerCase();renderList(rows.filter(r=>r.title.toLowerCase().includes(q)));});
  })
  .catch(err=>{$status.textContent="‚ùå "+err.message});

  function renderList(items){
    $list.innerHTML=items.map(r=>{
      const url=encodeURI(targetToPath(r.target));
      const d=r.date?`<span class="date">¬∑ ${formatDate(r.date)}</span>`:"";
      return `<li class="item"><a href="#" data-url="${url}">${escapeHtml(r.title)}</a> ${d}</li>`;
    }).join("");
    $count.textContent=items.length;
    $list.querySelectorAll("a").forEach(a=>{
      a.addEventListener("click",ev=>{ev.preventDefault();openNote(a.dataset.url);});
    });
  }

  function openNote(url){
    $viewer.hidden=false;$note.innerHTML="<p class='muted'>Cargando‚Ä¶</p>";
    fetch(url).then(async res=>{
      if(!res.ok) throw new Error("HTTP "+res.status);
      const md=await res.text();$note.innerHTML=marked.parse(md);$note.scrollIntoView({behavior:"smooth"});
    }).catch(err=>{$note.innerHTML=`<p>‚ùå ${err.message}</p><p><code>${url}</code></p>`;});
  }
  $back.addEventListener("click",e=>{e.preventDefault();$viewer.hidden=true;window.scrollTo({top:0,behavior:"smooth"});});
  function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
</script>
</body>
</html>
