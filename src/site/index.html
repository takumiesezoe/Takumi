<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>√çndice (debug) ‚Äî Takumi</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{margin:0;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0b0e;color:#f3f3f7}
  .wrap{max-width:920px;margin:40px auto;padding:0 16px}
  .card{background:#14141a;border:1px solid #232330;border-radius:14px;padding:18px}
  h1{margin:0 0 8px} code{background:#0f0f15;padding:2px 6px;border-radius:6px}
  .muted{color:#b8b8c6} .err{color:#ff6b6b}
  ul{list-style:none;padding:0;margin:12px 0;display:grid;gap:8px}
  li a{display:inline-block;padding:10px 12px;border:1px solid #232330;border-radius:10px;background:#0f0f15;color:#f3f3f7;text-decoration:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üóÇÔ∏è √çndice (debug)</h1>
    <p id="status" class="muted">Cargando‚Ä¶</p>
    <p class="muted">√çndice esperado en: <code id="showPath"></code></p>
    <ul id="lista"></ul>
    <div id="viewer" hidden>
      <hr />
      <div id="note"></div>
    </div>
  </div>
</div>

<script>
  // üîß Ajusta EXACTAMENTE (espacios/may√∫sculas tal cual en GitHub):
  const baseFolder = "Escritos/canciones poemas escritos";
  const mdPath = "notes/Escritos/canciones poemas escritos/Escritos_indice_con_enlace.md";

  const $status = document.getElementById("status");
  const $lista  = document.getElementById("lista");
  const $viewer = document.getElementById("viewer");
  const $note   = document.getElementById("note");
  document.getElementById("showPath").textContent = mdPath;

  function targetToPath(t){
    const clean = t.replace(/^notes\//,'').replace(/^\//,'');
    const withFolder = clean.includes('/') ? clean : `${baseFolder}/${clean}`;
    return `notes/${withFolder.replace(/\.md$/i,'')}.md`;
  }
  function titleFromTarget(t){ return decodeURIComponent(t.split('/').pop().replace(/\.md$/i,'')); }
  function escapeHtml(s){return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}

  async function fetchIndex(){
    const res = await fetch(encodeURI(mdPath));
    if(!res.ok) throw new Error(`No se pudo abrir el √≠ndice (${res.status} ${res.statusText})`);
    return res.text();
  }

  function extractLinks(md){
    // quita frontmatter/JSON si hay
    md = md.replace(/^---[\s\S]*?---\s*/,"").replace(/^\{[\s\S]*?\}\s*/,"");

    // primero prueba con vi√±etas t√≠picas "- [[Titulo]]"
    const bullet = [...md.matchAll(/^\s*[-*+]\s+\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/mg)];
    if (bullet.length) {
      return bullet.map(m => ({ target: m[1].trim(), title: (m[2]||titleFromTarget(m[1])).trim() }));
    }

    // si no hay vi√±etas, saca todos los [[links]]:
    const all = [...md.matchAll(/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g)];
    return all.map(m => ({ target: m[1].trim(), title: (m[2]||titleFromTarget(m[1])).trim() }));
  }

  function renderList(items){
    if (!items.length) {
      $status.innerHTML = `<span class="err">‚ö†Ô∏è No encontr√© wikilinks [[...]] en el √≠ndice.</span>`;
      return;
    }
    $status.textContent = `‚úÖ ${items.length} poemas`;
    $lista.innerHTML = items.map(it => {
      const url = encodeURI(targetToPath(it.target));
      return `<li><a href="#" data-url="${url}">${escapeHtml(it.title)}</a></li>`;
    }).join("");

    $lista.querySelectorAll("a").forEach(a=>{
      a.addEventListener("click", ev=>{
        ev.preventDefault();
        openNote(a.dataset.url);
      });
    });
  }

  function openNote(url){
    $viewer.hidden = false;
    $note.innerHTML = "<p class='muted'>Cargando poema‚Ä¶</p>";
    fetch(url)
      .then(r => {
        if(!r.ok) throw new Error(`No se pudo abrir ${url} (${r.status})`);
        return r.text();
      })
      .then(md => { $note.innerHTML = marked.parse(md); })
      .catch(e => { $note.innerHTML = `<p class="err">${escapeHtml(String(e))}</p><p><code>${url}</code></p>`; });
  }

  (async function main(){
    try{
      $status.textContent = "Leyendo √≠ndice‚Ä¶";
      const md = await fetchIndex();
      const links = extractLinks(md);
      if (!links.length) {
        $status.innerHTML = `<span class="err">No hay [[links]] en el √≠ndice o el formato no es el esperado.</span>`;
      }
      renderList(links);
    }catch(e){
      $status.innerHTML = `<span class="err">${escapeHtml(String(e.message||e))}</span>`;
    }
  })();
</script>
</body>
</html>
