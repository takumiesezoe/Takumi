<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Takumi‚Äôs Garden ‚Äî √çndice</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0a0a0a;           /* negro */
    --card:#131016;         /* negro con tinte granate */
    --ink:#f5f3f7;          /* texto claro */
    --muted:#b9a8ba;        /* gris rosado */
    --accent:#d36ea6;       /* rosado pastel */
    --garnet:#8b1e3f;       /* granate */
    --line:#241a24;         /* borde sutil */
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:42px auto;padding:0 18px}
  .card{background:linear-gradient(180deg,rgba(139,30,63,0.08),transparent 60%) , var(--card);
        border:1px solid var(--line);border-radius:18px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 6px;font-size:clamp(22px,4vw,34px);letter-spacing:.3px}
  .muted{color:var(--muted)}
  code{background:#0f0b10;border:1px solid var(--line);padding:2px 6px;border-radius:8px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 14px}
  input[type="search"]{flex:1;min-width:240px;background:#0f0b10;border:1px solid var(--line);color:var(--ink);
    padding:12px 14px;border-radius:12px;font-size:15px;outline:none}
  input[type="search"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(211,110,166,.2)}
  .badge{font-size:12px;color:#f1ddea;background:#2a1824;border:1px solid #442034;padding:3px 8px;border-radius:999px}
  ul.list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
  .item a{display:block;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#0f0b10;text-decoration:none;color:var(--ink)}
  .item a:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(211,110,166,.18)}
  .viewer{margin-top:18px;padding:18px;border:1px solid var(--line);border-radius:16px;background:#0f0b10}
  .back{display:inline-block;margin-bottom:10px;text-decoration:none;color:var(--accent)}
  .small{font-size:12px;color:var(--muted)}
  hr{border:none;border-top:1px solid var(--line);margin:14px 0}
  details{margin-top:10px}
  summary{cursor:pointer;color:#f6b3cf}
  .err{color:#ff8aa8}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üóÇÔ∏è √çndice de poemas</h1>
    <p id="status" class="muted">Buscando √≠ndice‚Ä¶</p>

    <div class="row">
      <input id="q" type="search" placeholder="Buscar t√≠tulo‚Ä¶" />
      <span id="count" class="badge">0</span>
    </div>

    <p class="small">√çndice encontrado en: <code id="chosenPath">‚Äî</code></p>
    <p class="small">Carpeta base detectada: <code id="baseFolderShow">‚Äî</code></p>

    <ul id="lista" class="list"></ul>

    <div id="viewer" class="viewer" hidden>
      <a href="#" id="back" class="back">‚Üê Volver al √≠ndice</a>
      <div id="note"></div>
      <details id="dbg" hidden>
        <summary>Ver URLs probadas</summary>
        <div id="tried"></div>
      </details>
    </div>
  </div>
</div>

<script>
  const $status = document.getElementById("status");
  const $lista  = document.getElementById("lista");
  const $viewer = document.getElementById("viewer");
  const $note   = document.getElementById("note");
  const $q      = document.getElementById("q");
  const $count  = document.getElementById("count");
  const $chosen = document.getElementById("chosenPath");
  const $baseShow = document.getElementById("baseFolderShow");
  const $back   = document.getElementById("back");
  const $dbg    = document.getElementById("dbg");
  const $tried  = document.getElementById("tried");

  // === Candidatos de √≠ndice (incluye tu estructura larga)
  const fileNames = [
    "indice pagina web.md","Indice pagina web.md","√≠ndice pagina web.md","√çndice pagina web.md",
    "Escritos_indice_con_enlace.md","index.md","Indice.md"
  ];
  const folders = [
    "notes/Escritos/Canciones-poemas-escritos/Canciones poemas escritos",
    "notes/Escritos/canciones poemas escritos",
    "notes/Escritos/Canciones poemas escritos",
    "notes/Escritos/Canciones-poemas-escritos",
    "notes/Escritos",
    "notes"
  ];
  const candidates=[]; for (const f of folders){ for(const n of fileNames){ candidates.push(`${f}/${n}`); } }

  // Utils
  function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
  function titleFromTarget(t){return decodeURIComponent(t.split('/').pop().replace(/\.md$/i,''));}
  const rmAccents = s => s.normalize('NFD').replace(/\p{Diacritic}+/gu,'');
  const stripPunct = s => s.replace(/[¬ø?¬°!:"‚Äú‚Äù‚Äò‚Äô'`.,;()/\\]+/g,'');
  function deduceBaseFolder(mdPath){ const p=mdPath.split("/"); p.pop(); return p.slice(1).join("/"); } // sin "notes/"
  async function tryFetch(url){ try{ const r=await fetch(encodeURI(url)); if(!r.ok) return null; return await r.text(); }catch{ return null; } }

  async function findIndex(){
    for(const p of candidates){ const t = await tryFetch(p); if(t!==null) return {path:p,text:t}; }
    return null;
  }

  function extractLinks(md){
    md = md.replace(/^---[\s\S]*?---\s*/,"").replace(/^\{[\s\S]*?\}\s*/,"");
    const bullet = [...md.matchAll(/^\s*[-*+]\s+\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/mg)];
    if(bullet.length){ return bullet.map(m=>({target:m[1].trim(), title:(m[2]||titleFromTarget(m[1])).trim()})); }
    const all = [...md.matchAll(/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g)];
    return all.map(m=>({target:m[1].trim(), title:(m[2]||titleFromTarget(m[1])).trim()}));
  }

  function renderList(items, baseFolder){
    if(!items.length){ $status.innerHTML = "<span class='muted'>‚ö†Ô∏è No encontr√© [[links]] en el √≠ndice.</span>"; return; }
    $status.textContent = "‚úÖ Cargado";
    $count.textContent = items.length;
    $lista.innerHTML = items.map(it=>{
      const href = buildCandidates(baseFolder, it.target)[0]; // primera candidata, solo para data
      return `<li class="item"><a href="#" data-target="${escapeHtml(it.target)}" data-base="${escapeHtml(baseFolder)}" data-hint="${escapeHtml(href)}">${escapeHtml(it.title)}</a></li>`;
    }).join("");
    $lista.querySelectorAll("a").forEach(a=>{
      a.addEventListener("click", ev=>{
        ev.preventDefault();
        const base = a.dataset.base;
        const target = a.dataset.target;
        openNoteProbing(base, target);
      });
    });
    // b√∫squeda
    $q.oninput = ()=>{
      const q = $q.value.toLowerCase();
      const filtered = items.filter(x=>x.title.toLowerCase().includes(q));
      $count.textContent = filtered.length;
      $lista.innerHTML = filtered.map(it=>{
        const href = buildCandidates(baseFolder, it.target)[0];
        return `<li class="item"><a href="#" data-target="${escapeHtml(it.target)}" data-base="${escapeHtml(baseFolder)}" data-hint="${escapeHtml(href)}">${escapeHtml(it.title)}</a></li>`;
      }).join("");
      $lista.querySelectorAll("a").forEach(a=>{
        a.addEventListener("click", ev=>{
          ev.preventDefault();
          openNoteProbing(a.dataset.base, a.dataset.target);
        });
      });
    };
  }

  // Genera m√∫ltiples URLs candidatas para un target
  function buildCandidates(baseFolder, target){
    // target puede venir con subcarpeta o con .md
    const bare = target.replace(/\.md$/i,'');
    const withMd = (x)=> `notes/${baseFolder}/${x}.md`;
    const keepMd = (x)=> `notes/${baseFolder}/${x}`;

    const variants = new Set();

    // tal cual
    variants.add(withMd(bare));
    variants.add(keepMd(target));

    // min√∫sculas
    variants.add(withMd(bare.toLowerCase()));
    variants.add(keepMd(target.toLowerCase()));

    // sin acentos
    const noAcc = rmAccents(bare);
    variants.add(withMd(noAcc));
    variants.add(withMd(noAcc.toLowerCase()));

    // sin signos raros
    const noPunct = stripPunct(bare);
    variants.add(withMd(noPunct));
    variants.add(withMd(noPunct.toLowerCase()));

    // espacios ‚Üí guiones y underscores
    const hyph = noPunct.replace(/\s+/g,'-');
    const unds = noPunct.replace(/\s+/g,'_');
    variants.add(withMd(hyph));
    variants.add(withMd(hyph.toLowerCase()));
    variants.add(withMd(unds));
    variants.add(withMd(unds.toLowerCase()));

    // por si realmente est√°n un nivel ARRIBA de la carpeta del √≠ndice
    const parent = baseFolder.split('/').slice(0,-1).join('/');
    if(parent){
      variants.add(`notes/${parent}/${bare}.md`);
      variants.add(`notes/${parent}/${bare.toLowerCase()}.md`);
      variants.add(`notes/${parent}/${noAcc}.md`);
      variants.add(`notes/${parent}/${noAcc.toLowerCase()}.md`);
      variants.add(`notes/${parent}/${hyph}.md`);
      variants.add(`notes/${parent}/${hyph.toLowerCase()}.md`);
    }

    return [...variants];
  }

  async function openNoteProbing(baseFolder, target){
    $viewer.hidden = false;
    $note.innerHTML = "<p class='muted'>Buscando el poema‚Ä¶</p>";
    $dbg.hidden = true; $tried.innerHTML = "";

    const candidates = buildCandidates(baseFolder, target);
    const tried = [];
    for(const url of candidates){
      tried.push(url);
      try{
        const res = await fetch(encodeURI(url));
        if(res.ok){
          const md = await res.text();
          $note.innerHTML = marked.parse(md);
          $note.scrollIntoView({behavior:"smooth"});
          return;
        }
      }catch(_){}
    }
    // Si no se encontr√≥, mostramos todas las URLs probadas para que ajustes el nombre exacto
    $note.innerHTML = `<p class="err">‚ùå No pude abrir el poema <b>${escapeHtml(target)}</b>.</p><p class="muted">Revisa may√∫sculas, acentos y signos del nombre del archivo en GitHub.</p>`;
    $dbg.hidden = false;
    $tried.innerHTML = "<ol>" + tried.map(u=>`<li><code>${escapeHtml(u)}</code></li>`).join("") + "</ol>";
  }

  // Arranque: auto-detectar √≠ndice, deducir carpeta base, listar links
  (async function main(){
    $status.textContent = "üîé Buscando √≠ndice‚Ä¶";
    const found = await (async ()=>{
      for(const p of candidates){
        const t = await tryFetch(p);
        if(t!==null) return {path:p,text:t};
      }
      return null;
    })();
    if(!found){
      $status.innerHTML = "‚ùå No encontr√© el archivo de √≠ndice en rutas comunes.<br><span class='small'>Crea o confirma un archivo como <code>indice pagina web.md</code> dentro de <code>src/site/notes/‚Ä¶</code>.</span>";
      return;
    }
    $chosen.textContent = found.path;
    const baseFolder = deduceBaseFolder(found.path); // sin 'notes/'
    $baseShow.textContent = baseFolder;

    const links = extractLinks(found.text);
    renderList(links, baseFolder);
  })();

  document.getElementById("back").addEventListener("click",(e)=>{e.preventDefault();$viewer.hidden=true;window.scrollTo({top:0,behavior:"smooth"});});
</script>
</body>
</html>
