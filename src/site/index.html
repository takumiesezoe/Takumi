<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Takumi‚Äôs Garden ‚Äî √çndice</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0a0a0a;      /* negro */
    --card:#131016;    /* negro con tinte granate */
    --ink:#f5f3f7;     /* texto claro */
    --muted:#b9a8ba;   /* gris rosado */
    --accent:#d36ea6;  /* rosado pastel */
    --garnet:#8b1e3f;  /* granate */
    --line:#241a24;    /* borde sutil */
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:42px auto;padding:0 18px}
  .card{
    background:linear-gradient(180deg,rgba(139,30,63,.08),transparent 60%),var(--card);
    border:1px solid var(--line);border-radius:18px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)
  }
  h1{margin:0 0 6px;font-size:clamp(22px,4vw,34px);letter-spacing:.3px}
  .muted{color:var(--muted)}
  code{background:#0f0b10;border:1px solid var(--line);padding:2px 6px;border-radius:8px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 14px}
  input[type="search"]{flex:1;min-width:240px;background:#0f0b10;border:1px solid var(--line);color:var(--ink);
    padding:12px 14px;border-radius:12px;font-size:15px;outline:none}
  input[type="search"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(211,110,166,.2)}
  .badge{font-size:12px;color:#f1ddea;background:#2a1824;border:1px solid #442034;padding:3px 8px;border-radius:999px}
  ul.list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
  .item{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .item a.main{display:inline-block;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#0f0b10;text-decoration:none;color:var(--ink)}
  .item a.main:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(211,110,166,.18)}
  .item a.try{font-size:12px;color:#f6b3cf;text-decoration:none}
  .item a.try:hover{text-decoration:underline}
  .viewer{margin-top:18px;padding:18px;border:1px solid var(--line);border-radius:16px;background:#0f0b10}
  .back{display:inline-block;margin-bottom:10px;text-decoration:none;color:var(--accent)}
  .small{font-size:12px;color:var(--muted)}
  .err{color:#ff8aa8}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üóÇÔ∏è √çndice de poemas</h1>
    <p id="status" class="muted">Cargando‚Ä¶</p>

    <div class="row">
      <input id="q" type="search" placeholder="Buscar t√≠tulo‚Ä¶" />
      <span id="count" class="badge">0</span>
    </div>

    <ul id="lista" class="list"></ul>

    <div id="viewer" class="viewer" hidden>
      <a href="#" id="back" class="back">‚Üê Volver al √≠ndice</a>
      <div id="note"></div>
    </div>
  </div>
</div>

<script>
  // üìå RUTAS (opci√≥n A es la que abre en tu sitio)
  const baseFolder = "Escritos/Canciones-poemas-escritos/Canciones poemas escritos";
  const mdPath     = `notes/${baseFolder}/indice pagina web.md`;

  const $status=document.getElementById("status"),
        $list=document.getElementById("lista"),
        $count=document.getElementById("count"),
        $q=document.getElementById("q"),
        $viewer=document.getElementById("viewer"),
        $note=document.getElementById("note"),
        $back=document.getElementById("back");

  // Utils
  const escapeHtml = s => s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const titleFromTarget = t => decodeURIComponent(t.split('/').pop().replace(/\.md$/i,''));

  async function getLinksFromIndex(){
    const res = await fetch(encodeURI(mdPath));
    if(!res.ok) throw new Error("No se pudo abrir el √≠ndice ("+res.status+")");
    let md = await res.text();
    // limpia frontmatter/json si existieran
    md = md.replace(/^---[\s\S]*?---\s*/,"").replace(/^\{[\s\S]*?\}\s*/,"");

    // extrae [[target|Title]] o [[target]]
    const re = /\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g;
    const out=[];
    let m;
    while((m=re.exec(md))){
      let target = m[1].trim().replace(/\\+/g,""); // quita barras invertidas accidentales
      let title  = (m[2]||titleFromTarget(target)).trim();
      if(!target) continue;
      out.push({target,title});
    }
    return out;
  }

  function renderList(items){
    if(!items.length){ $status.textContent="‚ö†Ô∏è √çndice vac√≠o"; return; }
    $count.textContent = items.length;
    $list.innerHTML = items.map(r=>{
      const url = encodeURI(`notes/${baseFolder}/${r.target}.md`);
      return `<li class="item">
        <a href="#" class="main" data-url="${url}">${escapeHtml(r.title)}</a>
        <a class="try" href="${url}" target="_blank" rel="noopener">probar directo</a>
      </li>`;
    }).join("");

    // abrir dentro del visor
    $list.querySelectorAll("a.main").forEach(a=>{
      a.addEventListener("click",ev=>{
        ev.preventDefault();
        openNote(a.dataset.url);
      });
    });
  }

  // Visor robusto con timeout y mensajes claros
  function openNote(url){
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 10000); // 10s

    $viewer.hidden=false;
    $note.innerHTML="<p class='muted'>Cargando‚Ä¶</p>";

    fetch(url,{signal:controller.signal})
      .then(res=>{ clearTimeout(t); if(!res.ok) throw new Error(`HTTP ${res.status}`); return res.text(); })
      .then(md=>{
        $note.innerHTML = marked.parse(md) + `<hr><p class="small">Fuente: <code>${url}</code></p>`;
        $note.scrollIntoView({behavior:"smooth"});
      })
      .catch(err=>{
        clearTimeout(t);
        $note.innerHTML = `
          <p class="err">‚ùå No se pudo abrir el poema.</p>
          <p class="small">Error: <code>${(err && err.message) || err}</code></p>
          <p class="small">URL intentada: <code>${url}</code></p>
          <p class="small"><a href="${url}" target="_blank" rel="noopener">Probar en pesta√±a nueva</a></p>
        `;
      });
  }

  // B√∫squeda en vivo (por t√≠tulo mostrado)
  function hookSearch(items){
    $q.addEventListener("input",()=>{
      const q = $q.value.toLowerCase();
      const filtered = items.filter(x=>x.title.toLowerCase().includes(q));
      $count.textContent = filtered.length;
      $list.innerHTML = filtered.map(r=>{
        const url = encodeURI(`notes/${baseFolder}/${r.target}.md`);
        return `<li class="item">
          <a href="#" class="main" data-url="${url}">${escapeHtml(r.title)}</a>
          <a class="try" href="${url}" target="_blank" rel="noopener">probar directo</a>
        </li>`;
      }).join("");
      $list.querySelectorAll("a.main").forEach(a=>{
        a.addEventListener("click",ev=>{
          ev.preventDefault();
          openNote(a.dataset.url);
        });
      });
    });
  }

  async function main(){
    try{
      $status.textContent="Leyendo √≠ndice‚Ä¶";
      const links = await getLinksFromIndex();
      renderList(links);
      $status.textContent="‚úÖ Cargado";
      hookSearch(links);
    }catch(e){
      $status.textContent="‚ùå "+String(e);
    }
  }

  $back.addEventListener("click",e=>{e.preventDefault();$viewer.hidden=true;window.scrollTo({top:0,behavior:"smooth"});});
  main();
</script>
</body>
</html>
