<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>√çndice de Poemas ‚Äî Takumi‚Äôs Garden</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b0b0e;--card:#14141a;--muted:#b8b8c6;--text:#f3f3f7;--accent:#a78bfa}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:920px;margin:48px auto;padding:24px}
  .card{background:var(--card);border:1px solid #1f1f28;border-radius:16px;padding:24px}
  h1{margin:0 0 8px;font-size:clamp(22px,4vw,34px)}p.muted{color:var(--muted);margin:0 0 16px}
  .controls{display:flex;gap:12px;align-items:center;margin:8px 0 16px}
  input[type="search"]{flex:1;background:#0e0e13;border:1px solid #2a2a37;color:var(--text);padding:12px 14px;border-radius:12px;font-size:16px}
  .badge{font-size:12px;color:#c7c7d4;background:#1a1a24;border:1px solid #2a2a37;padding:3px 8px;border-radius:999px}
  ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
  .item a{display:inline-block;padding:12px 14px;border:1px solid #232330;border-radius:12px;background:#0f0f15;text-decoration:none;color:var(--text)}
  .item a:hover{border-color:var(--accent)}.date{margin-left:10px;color:#c9c9d3;font-size:12px}
  .viewer{margin-top:18px;padding:18px;border:1px solid #232330;border-radius:14px;background:#0f0f15}
  .back{display:inline-block;margin-bottom:10px;text-decoration:none;color:var(--accent)}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="wrap"><div class="card">
  <h1>üóÇÔ∏è √çndice de poemas</h1>
  <p id="status" class="muted">Cargando‚Ä¶</p>
  <div class="controls">
    <input id="q" type="search" placeholder="Buscar t√≠tulo‚Ä¶" />
    <span id="count" class="badge">0</span>
  </div>
  <ul id="lista" class="list"></ul>
  <div id="viewer" class="viewer" hidden>
    <a href="#" id="back" class="back">‚Üê Volver al √≠ndice</a>
    <div id="note"></div>
  </div>
</div></div>

<script>
  // RUTAS: ajusta si cambias carpetas
  const mdPath = "notes/Escritos/Canciones-poemas-escritos/Escritos_indice_con_enlace.md";
  const baseFolder = "Escritos/Canciones-poemas-escritos"; // donde est√°n tus poemas .md

  const $status=document.getElementById("status"),$list=document.getElementById("lista"),
        $count=document.getElementById("count"),$q=document.getElementById("q"),
        $viewer=document.getElementById("viewer"),$note=document.getElementById("note"),
        $back=document.getElementById("back");

  // ======== Utilidades de fecha (ES/EN) ========
  const MONTHS = {enero:1,febrero:2,marzo:3,abril:4,mayo:5,junio:6,julio:7,agosto:8,septiembre:9,setiembre:9,octubre:10,noviembre:11,diciembre:12,
                  january:1,february:2,march:3,april:4,may:5,june:6,july:7,august:8,september:9,october:10,november:11,december:12};

  // 1) Fecha desde frontmatter YAML
  function getFrontmatterDate(text){
    const m = text.match(/^---\s*[\s\S]*?---/);
    if(!m) return null;
    const fm = m[0];
    // Busca l√≠neas tipo "date: 2025-09-15 18:44" o "created: 2025-09-15T18:44"
    const rx = /^\s*(date|created)\s*:\s*["']?([0-9]{4}-[0-9]{2}-[0-9]{2})(?:[ T]([0-9]{2}):([0-9]{2}))?["']?\s*$/mi;
    const mm = fm.match(rx);
    if(!mm) return null;
    const Y=+mm[2].slice(0,4), M=+mm[2].slice(5,7), D=+mm[2].slice(8,10);
    const h= mm[3]?+mm[3]:0, mi=mm[4]?+mm[4]:0;
    return new Date(Y,M-1,D,h,mi);
  }

  // 2) Fecha desde l√≠nea tipo: "6:44 p. m. - septiembre 15, 2025"
  function getSpanishStamp(text){
    // Busca la primera ocurrencia en todo el archivo
    const rx = /(\d{1,2}):(\d{2})\s*(a\.?\s?m\.?|p\.?\s?m\.?|AM|PM)\s*-\s*([A-Za-z√°√©√≠√≥√∫√±]+)\s+(\d{1,2}),\s*(\d{4})/i;
    const m = text.match(rx);
    if(!m) return null;
    let h=+m[1], mi=+m[2], ap=m[3].toLowerCase(), mesTxt=m[4].toLowerCase(), D=+m[5], Y=+m[6];
    const M = MONTHS[mesTxt]; if(!M) return null;
    if(/p/.test(ap) && h<12) h+=12;
    if(/a/.test(ap) && h===12) h=0;
    return new Date(Y,M-1,D,h,mi);
  }

  function formatDate(d){
    if(!d) return "";
    const short=['ene','feb','mar','abr','may','jun','jul','ago','sept','oct','nov','dic'];
    const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
    return `${d.getDate()} ${short[d.getMonth()]} ${d.getFullYear()} ${hh}:${mm}`;
  }

  function titleFromTarget(t){return decodeURIComponent(t.split("/").pop().replace(/\.md$/i,""));}
  function targetToPath(t){
    const clean=t.replace(/^notes\//,'').replace(/^\//,'');
    const withFolder=clean.includes('/')?clean:`${baseFolder}/${clean}`;
    return `notes/${withFolder.replace(/\.md$/i,'')}.md`;
  }

  // Lee el √≠ndice, saca wikilinks √∫nicos
  async function getLinksFromIndex(){
    const res = await fetch(encodeURI(mdPath));
    if(!res.ok) throw new Error("HTTP "+res.status+" al abrir √≠ndice");
    let md = await res.text();
    // quita frontmatter/JSON si hay
    md = md.replace(/^---[\s\S]*?---\s*/,"").replace(/^\{[\s\S]*?\}\s*/,"");
    const re = /\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g;
    const seen = new Map();
    let m;
    while((m=re.exec(md))){
      const target = m[1].trim();
      const title  = (m[2] || titleFromTarget(target)).trim();
      seen.set(target, title);
    }
    return [...seen.entries()].map(([target,title])=>({target,title}));
  }

  // Para cada nota, busca fecha (frontmatter > sello espa√±ol)
  async function enrichWithDate(entry){
    const url = targetToPath(entry.target);
    try{
      const res = await fetch(encodeURI(url));
      if(!res.ok) throw new Error("HTTP "+res.status);
      const text = await res.text();
      const d1 = getFrontmatterDate(text);
      const d2 = d1 || getSpanishStamp(text);
      return {...entry, date: d2 || null, url};
    }catch(e){
      return {...entry, date: null, url, err: String(e)};
    }
  }

  // Render
  function renderList(items){
    const $list=document.getElementById("lista"), $count=document.getElementById("count");
    $list.innerHTML = items.map(r=>{
      const d = r.date ? `<span class="date">¬∑ ${formatDate(r.date)}</span>` : "";
      return `<li class="item"><a href="#" data-url="${encodeURI(r.url)}">${escapeHtml(r.title)}</a> ${d}</li>`;
    }).join("");
    $count.textContent = items.length;

    // abrir nota dentro
    $list.querySelectorAll("a").forEach(a=>{
      a.addEventListener("click",(ev)=>{ev.preventDefault();openNote(a.dataset.url);});
    });
  }

  async function main(){
    try{
      $status.textContent = "Leyendo √≠ndice‚Ä¶";
      const links = await getLinksFromIndex();
      if(links.length===0){ $status.textContent="‚ö†Ô∏è √çndice vac√≠o"; return; }

      $status.textContent = "Leyendo fechas de cada poema‚Ä¶";
      const enriched = await Promise.all(links.map(enrichWithDate));

      // Orden: nuevo‚Üíviejo por fecha+hora; sin fecha al final por t√≠tulo
      enriched.sort((a,b)=>{
        if(a.date && b.date) return b.date - a.date;
        if(a.date && !b.date) return -1;
        if(!a.date && b.date) return 1;
        return a.title.localeCompare(b.title,"es",{sensitivity:"base"});
      });

      renderList(enriched);
      $status.textContent = "‚úÖ Cargado";
      $q.addEventListener("input",()=>{
        const q=$q.value.toLowerCase();
        const filtered = enriched.filter(r=>r.title.toLowerCase().includes(q));
        renderList(filtered);
      });
    }catch(e){
      $status.textContent = "‚ùå "+String(e);
    }
  }

  function openNote(url){
    $viewer.hidden=false;$note.innerHTML="<p class='muted'>Cargando‚Ä¶</p>";
    fetch(url).then(async res=>{
      if(!res.ok) throw new Error("HTTP "+res.status);
      const md=await res.text();$note.innerHTML=marked.parse(md);$note.scrollIntoView({behavior:"smooth"});
    }).catch(err=>{$note.innerHTML=`<p>‚ùå ${err.message}</p><p><code>${url}</code></p>`;});
  }

  function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}

  // Arrancar
  main();
  $back.addEventListener("click",e=>{e.preventDefault();$viewer.hidden=true;window.scrollTo({top:0,behavior:"smooth"});});
</script>
</body>
</html>

