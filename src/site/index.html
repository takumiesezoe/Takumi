<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>√çndice (auto) ‚Äî Takumi</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{margin:0;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0b0e;color:#f3f3f7}
  .wrap{max-width:920px;margin:40px auto;padding:0 16px}
  .card{background:#14141a;border:1px solid #232330;border-radius:14px;padding:18px}
  h1{margin:0 0 8px} code{background:#0f0f15;padding:2px 6px;border-radius:6px}
  .muted{color:#b8b8c6} .err{color:#ff6b6b}
  ul{list-style:none;padding:0;margin:12px 0;display:grid;gap:8px}
  li a{display:inline-block;padding:10px 12px;border:1px solid #232330;border-radius:10px;background:#0f0f15;color:#f3f3f7;text-decoration:none}
  .small{font-size:12px;color:#b8b8c6}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üóÇÔ∏è √çndice (auto-detecci√≥n)</h1>
    <p id="status" class="muted">Buscando √≠ndice‚Ä¶</p>
    <p class="small">Probando rutas t√≠picas‚Ä¶</p>
    <p class="small">√çndice encontrado en: <code id="chosenPath">‚Äî</code></p>
    <p class="small">Carpeta base de poemas: <code id="baseFolderShow">‚Äî</code></p>
    <ul id="lista"></ul>
    <div id="viewer" hidden>
      <hr />
      <div id="note"></div>
    </div>
  </div>
</div>

<script>
  const $status = document.getElementById("status");
  const $lista  = document.getElementById("lista");
  const $viewer = document.getElementById("viewer");
  const $note   = document.getElementById("note");
  const $chosen = document.getElementById("chosenPath");
  const $baseShow = document.getElementById("baseFolderShow");

  // Genera candidatos de rutas para el √≠ndice
  const fileNames = [
    "indice pagina web.md","Indice pagina web.md","√≠ndice pagina web.md","√çndice pagina web.md",
    "Escritos_indice_con_enlace.md","escritos_indice_con_enlace.md","Indice.md","index.md"
  ];

  const folders = [
    "notes/Escritos/canciones poemas escritos",
    "notes/Escritos/Canciones poemas escritos",
    "notes/Escritos/Canciones-poemas-escritos",
    "notes/Escritos/Canciones Poemas Escritos",
    "notes/Escritos/canciones-poemas-escritos",
    "notes/Escritos",
    "notes"
  ];

  const candidates = [];
  for (const f of folders){
    for (const n of fileNames){
      candidates.push(`${f}/${n}`);
    }
  }

  function titleFromTarget(t){ return decodeURIComponent(t.split('/').pop().replace(/\.md$/i,'')); }
  function escapeHtml(s){return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}

  function deduceBaseFolder(mdPath){
    // mdPath = "notes/<carpeta‚Ä¶>/archivo.md"
    const parts = mdPath.split("/");
    parts.pop(); // quita archivo
    const base = parts.slice(1).join("/"); // quita "notes/"
    return base; // ejemplo: "Escritos/canciones poemas escritos"
  }

  function targetToPath(baseFolder, target){
    const clean = target.replace(/^notes\//,'').replace(/^\//,'');
    const withFolder = clean.includes('/') ? clean : `${baseFolder}/${clean}`;
    return `notes/${withFolder.replace(/\.md$/i,'')}.md`;
  }

  async function tryFetch(url){
    try{
      const res = await fetch(encodeURI(url));
      if(!res.ok) return null;
      return await res.text();
    }catch{ return null; }
  }

  async function findIndex(){
    for (const p of candidates){
      const txt = await tryFetch(p);
      if (txt !== null) return { path: p, text: txt };
    }
    return null;
  }

  function extractLinks(md){
    md = md.replace(/^---[\s\S]*?---\s*/,"").replace(/^\{[\s\S]*?\}\s*/,"");
    // primero intenta vi√±etas t√≠picas
    const bullet = [...md.matchAll(/^\s*[-*+]\s+\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/mg)];
    if (bullet.length) {
      return bullet.map(m => ({ target: m[1].trim(), title: (m[2]||titleFromTarget(m[1])).trim() }));
    }
    // si no, todos los [[links]]
    const all = [...md.matchAll(/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g)];
    return all.map(m => ({ target: m[1].trim(), title: (m[2]||titleFromTarget(m[1])).trim() }));
  }

  function renderList(items, baseFolder){
    if (!items.length) {
      $status.innerHTML = `<span class="err">‚ö†Ô∏è No encontr√© [[links]] en el √≠ndice.</span>`;
      return;
    }
    $status.textContent = `‚úÖ ${items.length} poemas`;
    $lista.innerHTML = items.map(it => {
      const url = encodeURI(targetToPath(baseFolder, it.target));
      return `<li><a href="#" data-url="${url}">${escapeHtml(it.title)}</a></li>`;
    }).join("");
    $lista.querySelectorAll("a").forEach(a=>{
      a.addEventListener("click", ev=>{
        ev.preventDefault();
        openNote(a.dataset.url);
      });
    });
  }

  function openNote(url){
    $viewer.hidden = false;
    $note.innerHTML = "<p class='muted'>Cargando poema‚Ä¶</p>";
    fetch(url)
      .then(r => { if(!r.ok) throw new Error(`No se pudo abrir ${url} (${r.status})`); return r.text(); })
      .then(md => { $note.innerHTML = marked.parse(md); })
      .catch(e => { $note.innerHTML = `<p class="err">${escapeHtml(String(e))}</p><p><code>${url}</code></p>`; });
  }

  (async function main(){
    $status.textContent = "Buscando √≠ndice en varias rutas‚Ä¶";
    const found = await findIndex();
    if (!found){
      $status.innerHTML = `<span class="err">‚ùå No encontr√© el archivo de √≠ndice en rutas comunes.</span>
        <br><span class="small">Aseg√∫rate de que existe un archivo como <code>indice pagina web.md</code> dentro de <code>src/site/notes/‚Ä¶</code>.</span>`;
      return;
    }
    $chosen.textContent = found.path;
    const baseFolder = deduceBaseFolder(found.path.replace(/^notes\//,'notes/'));
    $baseShow.textContent = baseFolder;
    const links = extractLinks(found.text);
    renderList(links, baseFolder);
  })();
</script>
</body>
</html>
