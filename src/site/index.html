<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>√çndice de Poemas ‚Äî Takumi‚Äôs Garden</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { --bg:#0b0b0e; --card:#14141a; --muted:#b8b8c6; --text:#f3f3f7; --accent:#a78bfa; }
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
      .wrap{max-width:920px;margin:48px auto;padding:24px}
      .card{background:var(--card);border:1px solid #1f1f28;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
      h1{margin:0 0 8px;font-size:clamp(22px,4vw,34px)}
      p.muted{color:var(--muted);margin:0 0 16px}
      .controls{display:flex;gap:12px;align-items:center;margin:8px 0 16px}
      input[type="search"]{flex:1;background:#0e0e13;border:1px solid #2a2a37;color:var(--text);padding:12px 14px;border-radius:12px;font-size:16px}
      .badge{font-size:12px;color:#c7c7d4;background:#1a1a24;border:1px solid #2a2a37;padding:3px 8px;border-radius:999px}
      ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
      .item a{display:block;padding:12px 14px;border:1px solid #232330;border-radius:12px;background:#0f0f15;text-decoration:none;color:var(--text);transition:.15s}
      .item a:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(167,139,250,.15)}
      .ok{color:#10b981}.err{color:#ef4444}
      .viewer{margin-top:18px;padding:18px;border:1px solid #232330;border-radius:14px;background:#0f0f15}
      .back{display:inline-block;margin-bottom:10px;text-decoration:none;color:var(--accent)}
      footer{margin-top:18px;color:var(--muted);font-size:12px}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>üóÇÔ∏è √çndice de poemas</h1>
        <p id="status" class="muted">Cargando‚Ä¶</p>
        <div class="controls">
          <input id="q" type="search" placeholder="Buscar t√≠tulo‚Ä¶" aria-label="Buscar" />
          <span id="count" class="badge">0</span>
        </div>

        <ul id="lista" class="list"></ul>

        <div id="viewer" class="viewer" hidden>
          <a href="#" id="back" class="back">‚Üê Volver al √≠ndice</a>
          <div id="note"></div>
        </div>

        <footer>Fuente: <code id="ruta"></code></footer>
      </div>
    </div>

    <script>
      // RUTA EXACTA de tu √≠ndice dentro de src/site/
      const mdPath = "notes/Escritos/Canciones-poemas-escritos/Escritos_indice_con_enlace.md";

      const $ruta   = document.getElementById("ruta");
      const $status = document.getElementById("status");
      const $list   = document.getElementById("lista");
      const $count  = document.getElementById("count");
      const $q      = document.getElementById("q");
      const $viewer = document.getElementById("viewer");
      const $note   = document.getElementById("note");
      const $back   = document.getElementById("back");
      $ruta.textContent = mdPath;

      // Utilidades
      function parseDate(s){
        // limpia cosas tipo "6:44 PM - September 15, 2025"
        if(!s) return null;
        s = s.replace(/^[^A-Za-z0-9]+/,"");         // quita guiones, espacios
        // si tiene " - " nos quedamos con la parte de la fecha
        const parts = s.split(" - ");
        const dateStr = parts.length>1 ? parts[1] : s;
        const d = new Date(dateStr.trim());
        return isNaN(d) ? null : d;
      }
      function titleFromTarget(t){
        const seg = t.split("/").pop();
        return decodeURIComponent(seg.replace(/\.md$/i,""));
      }
      function hrefFromTarget(t){
        const target = t.endsWith(".md") ? t : t + ".md";
        return "notes/" + target.replace(/^notes\//,"");
      }

      // Cargar el √≠ndice .md y parsear tabla (N¬∫ | Idioma | Fecha | T√≠tulo)
      fetch(encodeURI(mdPath))
        .then(async res => {
          if(!res.ok) throw new Error("HTTP " + res.status + " ("+res.statusText+")");
          let md = await res.text();

          // Quitar YAML/frontmatter arriba y bloques JSON
          md = md.replace(/^---[\s\S]*?---\s*/,"");
          md = md.replace(/^\{[\s\S]*?\}\s*/,"");

          const lines = md.split(/\r?\n/);
          const rows = [];

          for(const ln of lines){
            // fila de tabla con '|' y un wikilink
            if(ln.includes("|") && ln.includes("[[")){
              const cells = ln.split("|").map(c => c.trim());
              // esperados: "", N¬∫, Idioma, Fecha, T√≠tulo, "" (por bordes)
              let dateCell = null, linkCell = null;
              // busca la celda con fecha (contiene mes en ingl√©s) y la del link
              for(const c of cells){
                if(/\[\[.+\]\]/.test(c)) linkCell = c;
                if(/\b(January|February|March|April|May|June|July|August|September|October|November|December)\b/i.test(c)){
                  dateCell = c;
                }
              }
              if(linkCell){
                const m = linkCell.match(/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/);
                if(m){
                  const target = m[1].trim();
                  const title  = (m[2] || titleFromTarget(target)).trim();
                  const date   = parseDate(dateCell || "");
                  rows.push({title, target, date});
                }
              }
            }
          }

          // Si no detecta tabla, como fallback extrae todos los [[links]] y sin fecha
          if(rows.length===0){
            const all = [...md.matchAll(/\[\{0,0}\]/g)]; // dummy to keep syntax highlighter calm
          }
          if(rows.length===0){
            const map = new Map();
            const re = /\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g;
            let m; 
            while((m = re.exec(md))){
              const target = m[1].trim();
              const title  = (m[2] || titleFromTarget(target)).trim();
              map.set(target, title);
            }
            for(const [target,title] of map.entries()){
              rows.push({title, target, date:null});
            }
          }

          // Ordenar por fecha (nuevos primero); sin fecha al final por t√≠tulo
          rows.sort((a,b)=>{
            if(a.date && b.date) return b.date - a.date;
            if(a.date && !b.date) return -1;
            if(!a.date && b.date) return 1;
            return a.title.localeCompare(b.title,"es",{sensitivity:"base"});
          });

          renderList(rows);
          $status.innerHTML = "<span class='ok'>‚úÖ Cargado</span>";

          // Buscador
          $q.addEventListener("input", ()=>{
            const q = $q.value.trim().toLowerCase();
            const filtered = rows.filter(r => r.title.toLowerCase().includes(q));
            renderList(filtered);
          });

        }).catch(err=>{
          $status.innerHTML = "<span class='err'>‚ùå "+err.message+"</span><br>Comprueba que existe <code>src/site/"+mdPath+"</code>";
        });

      function renderList(items){
        $list.innerHTML = items.map(r=>{
          const href = "./" + encodeURI(hrefFromTarget(r.target));
          return `<li class="item"><a href="${href}" data-target="${encodeURI(hrefFromTarget(r.target))}">${escapeHtml(r.title)}</a></li>`;
        }).join("");
        $count.textContent = items.length;

        // Interceptar clic ‚Üí abrir la nota dentro de la p√°gina (sin 404)
        $list.querySelectorAll("a").forEach(a=>{
          a.addEventListener("click", (ev)=>{
            ev.preventDefault();
            const url = a.getAttribute("data-target");
            openNote(url);
          });
        });
      }

      function openNote(url){
        $viewer.hidden = false;
        $note.innerHTML = "<p class='muted'>Cargando‚Ä¶</p>";
        fetch(encodeURI(url))
          .then(async res=>{
            if(!res.ok) throw new Error("HTTP " + res.status + " ("+res.statusText+")");
            const md = await res.text();
            $note.innerHTML = marked.parse(md);
            $note.scrollIntoView({behavior:"smooth", block:"start"});
          })
          .catch(err=>{
            $note.innerHTML = `<p class="err">‚ùå No se pudo abrir la nota: ${escapeHtml(err.message)}</p><p>Ruta: <code>${escapeHtml(url)}</code></p>`;
          });
      }

      document.getElementById("back").addEventListener("click", (e)=>{
        e.preventDefault();
        $viewer.hidden = true;
        window.scrollTo({top:0, behavior:"smooth"});
      });

      function escapeHtml(s){return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
    </script>
  </body>
</html>
