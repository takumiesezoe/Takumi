<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>√çndice de Poemas ‚Äî Takumi‚Äôs Garden</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { --bg:#0b0b0e; --card:#14141a; --muted:#b8b8c6; --text:#f3f3f7; --accent:#a78bfa; }
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
      .wrap{max-width:920px;margin:48px auto;padding:24px}
      .card{background:var(--card);border:1px solid #1f1f28;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
      h1{margin:0 0 8px;font-size:clamp(22px,4vw,34px)}
      p.muted{color:var(--muted);margin:0 0 16px}
      .controls{display:flex;gap:12px;align-items:center;margin:8px 0 16px}
      input[type="search"]{flex:1;background:#0e0e13;border:1px solid #2a2a37;color:var(--text);padding:12px 14px;border-radius:12px;font-size:16px}
      .badge{font-size:12px;color:#c7c7d4;background:#1a1a24;border:1px solid #2a2a37;padding:3px 8px;border-radius:999px}
      ul.list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
      .item a{display:block;padding:12px 14px;border:1px solid #232330;border-radius:12px;background:#0f0f15;text-decoration:none;color:var(--text);transition:.15s}
      .item a:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(167,139,250,.15)}
      .ok{color:#10b981}.err{color:#ef4444}
      .viewer{margin-top:18px;padding:18px;border:1px solid #232330;border-radius:14px;background:#0f0f15}
      .back{display:inline-block;margin-bottom:10px;text-decoration:none;color:var(--accent)}
      footer{margin-top:18px;color:var(--muted);font-size:12px}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>üóÇÔ∏è √çndice de poemas</h1>
        <p id="status" class="muted">Cargando‚Ä¶</p>
        <div class="controls">
          <input id="q" type="search" placeholder="Buscar t√≠tulo‚Ä¶" aria-label="Buscar" />
          <span id="count" class="badge">0</span>
        </div>

        <ul id="lista" class="list"></ul>

        <div id="viewer" class="viewer" hidden>
          <a href="#" id="back" class="back">‚Üê Volver al √≠ndice</a>
          <div id="note"></div>
        </div>

        <footer>Fuente: <code id="ruta"></code></footer>
      </div>
    </div>

    <script>
      // üëâ Ajusta la ruta EXACTA a tu √≠ndice .md (case-sensitive)
      const mdPath = "notes/Escritos/Canciones-poemas-escritos/Escritos_indice_con_enlace.md";

      const $ruta   = document.getElementById("ruta");
      const $status = document.getElementById("status");
      const $list   = document.getElementById("lista");
      const $count  = document.getElementById("count");
      const $q      = document.getElementById("q");
      const $viewer = document.getElementById("viewer");
      const $note   = document.getElementById("note");
      const $back   = document.getElementById("back");
      $ruta.textContent = mdPath;

      // ==== Funci√≥n de parseo de fechas (ES + EN) ====
      function parseDate(raw){
        if(!raw) return null;
        let s = String(raw).trim();
        s = s.replace(/^\s*[\-\‚Äì]\s*/,'').replace(/^\s*\d{1,2}:\d{2}\s?(AM|PM)\s?\-\s?/i,'');
        s = s.replace(/\s+/g,' ').trim();
        const monthsES = {enero:1,febrero:2,marzo:3,abril:4,mayo:5,junio:6,julio:7,agosto:8,septiembre:9,setiembre:9,octubre:10,noviembre:11,diciembre:12};
        const monthsEN = {january:1,february:2,march:3,april:4,may:5,june:6,july:7,august:8,september:9,october:10,november:11,december:12};
        let m;

        if(m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})(?:[ T](\d{1,2}):(\d{2}))?$/)) return new Date(+m[1],+m[2]-1,+m[3],m[4]||0,m[5]||0);
        if(m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})(?:[ T](\d{1,2}):(\d{2}))?$/)) return new Date(+m[3],+m[2]-1,+m[1],m[4]||0,m[5]||0);
        if(m = s.match(/^(\d{1,2})\s+([A-Za-z√°√©√≠√≥√∫√±]+)\s+(\d{4})$/i)){const D=+m[1],mes=m[2].toLowerCase(),Y=+m[3];const M=monthsES[mes]||monthsEN[mes];if(M)return new Date(Y,M-1,D);}
        if(m = s.match(/^([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})$/)){const mes=m[1].toLowerCase(),D=+m[2],Y=+m[3];const M=monthsEN[mes];if(M)return new Date(Y,M-1,D);}
        if(m = s.match(/(\d{1,2})\s+([A-Za-z√°√©√≠√≥√∫√±]+)\s+(\d{4})/i)){const D=+m[1],mes=m[2].toLowerCase(),Y=+m[3];const M=monthsES[mes]||monthsEN[mes];if(M)return new Date(Y,M-1,D);}
        const dt=new Date(s);return isNaN(dt)?null:dt;
      }

      function titleFromTarget(t){return decodeURIComponent(t.split("/").pop().replace(/\.md$/i,""));}
      function hrefFromTarget(t){const target=t.endsWith(".md")?t:t+".md";return "notes/"+target.replace(/^notes\//,"");}

      // ==== Cargar √≠ndice y parsear tabla ====
      fetch(encodeURI(mdPath))
        .then(async res => {
          if(!res.ok) throw new Error("HTTP " + res.status);
          let md = await res.text();
          md = md.replace(/^---[\s\S]*?---\s*/,"");
          md = md.replace(/^\{[\s\S]*?\}\s*/,"");
          const lines = md.split(/\r?\n/);

          let headerIdx=-1,dateCol=-1,linkCol=-1;
          for(let i=0;i<lines.length;i++){if(lines[i].includes('|') && /---/.test(lines[i+1]||'')){headerIdx=i;break;}}
          if(headerIdx>=0){
            const headers=lines[headerIdx].split('|').map(c=>c.trim().toLowerCase());
            headers.forEach((h,idx)=>{if(/fecha|creaci[o√≥]n|date/.test(h))dateCol=idx;if(/t[i√≠]tulo|title/.test(h))linkCol=idx;});
          }

          const rows=[];
          for(let i=(headerIdx>=0?headerIdx+2:0);i<lines.length;i++){
            const cells=lines[i].split('|').map(c=>c.trim());
            if(cells.length<2) continue;
            let linkCellText=null;
            if(linkCol>=0 && /\[\[.+\]\]/.test(cells[linkCol])) linkCellText=cells[linkCol];
            else linkCellText=cells.find(c=>/\[\[.+\]\]/.test(c));
            if(!linkCellText) continue;
            const m=linkCellText.match(/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/);
            if(!m) continue;
            const target=m[1].trim(), title=(m[2]||titleFromTarget(target)).trim();
            let dateText=(dateCol>=0&&cells[dateCol])?cells[dateCol]:'';
            if(!dateText){dateText=cells.find(c=>/\d{4}|\b(enero|febrero|...|december)\b/i.test(c))||'';}
            const date=parseDate(dateText);
            rows.push({title,target,date});
          }

          if(rows.length===0){
            const re=/\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/g;let m;const map=new Map();
            while((m=re.exec(md))){map.set(m[1].trim(),(m[2]||titleFromTarget(m[1])).trim());}
            for(const [target,title] of map.entries()){rows.push({title,target,date:null});}
          }

          rows.sort((a,b)=>{if(a.date&&b.date)return b.date-a.date;if(a.date&&!b.date)return -1;if(!a.date&&b.date)return 1;return a.title.localeCompare(b.title,"es",{sensitivity:"base"});});

          renderList(rows);
          $status.innerHTML="<span class='ok'>‚úÖ Cargado</span>";
          $q.addEventListener("input",()=>{const q=$q.value.toLowerCase();renderList(rows.filter(r=>r.title.toLowerCase().includes(q)));});
        })
        .catch(err=>{$status.innerHTML="<span class='err'>‚ùå "+err.message+"</span>";});

      function renderList(items){
        $list.innerHTML=items.map(r=>`<li class="item"><a href="#" data-target="${encodeURI(hrefFromTarget(r.target))}">${escapeHtml(r.title)}</a></li>`).join("");
        $count.textContent=items.length;
        $list.querySelectorAll("a").forEach(a=>{a.addEventListener("click",ev=>{ev.preventDefault();openNote(a.dataset.target);});});
      }

      function openNote(url){
        $viewer.hidden=false;$note.innerHTML="<p class='muted'>Cargando‚Ä¶</p>";
        fetch(encodeURI(url)).then(async res=>{
          if(!res.ok) throw new Error("HTTP "+res.status);
          const md=await res.text();
          $note.innerHTML=marked.parse(md);
          $note.scrollIntoView({behavior:"smooth"});
        }).catch(err=>{$note.innerHTML=`<p class="err">‚ùå ${escapeHtml(err.message)}</p><p><code>${url}</code></p>`;});
      }
      $back.addEventListener("click",e=>{e.preventDefault();$viewer.hidden=true;window.scrollTo({top:0,behavior:"smooth"});});
      function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
    </script>
  </body>
</html>
